---
# kcpassword from https://github.com/veertuinc/kcpassword.git
- name: make sure /usr/local/bin is present and writeable
  become: true
  file:
    path: /usr/local/bin
    owner: "{{ param_user }}"
    group: staff
    state: directory
    mode: '0775'

- name: kcpassword python file
  copy:
    src: kcpassword
    dest: /usr/local/bin/kcpassword
    owner: "{{ param_user }}"
    group: staff
    mode: '0700'

- name: run kcpassword
  become: true
  command: /usr/bin/python3 /usr/local/bin/kcpassword "{{ password_of_param_user }}"

- name: add "{{ param_user }}" to defaults autologin
  become: true
  command: /usr/bin/defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser "{{ param_user }}"

- name: Fail if kcpasswd fails
  become: true
  shell: "ls -al /etc/kcpassword"
